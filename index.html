<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redator Nota 1000 - Corretor de Redação ENEM & SSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <script src="https://unpkg.com/lucide@0.320.0/dist/umd/lucide.js"></script>
    <!-- PDF Processing Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }

        .sidebar-icon {
            transition: all 0.2s ease-in-out;
        }

        .sidebar-icon:hover,
        .sidebar-icon.active {
            background-color: #4f46e5;
            color: white;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .prose-custom ul {
            list-style-type: disc;
            padding-left: 20px;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .prose-custom h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-top: 1.75rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.25rem;
        }

        .prose-custom h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: #4f46e5;
        }

        .prose-custom p {
            line-height: 1.6;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a5a5a5;
        }

        .tab-button,
        .mode-button {
            transition: all 0.2s ease;
        }

        .achievement-card {
            transition: all 0.3s ease;
        }

        .achievement-card.unlocked {
            border-color: #fbbf24;
            background-color: #fffbeb;
        }

        .achievement-card.locked {
            opacity: 0.6;
            filter: grayscale(80%);
        }
    </style>
</head>

<body class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-20 bg-indigo-700 text-white p-4 flex flex-col items-center space-y-8 shadow-lg">
        <div class="font-bold text-xl">R1k</div>
        <nav class="flex flex-col items-center space-y-6">
            <button onclick="navigateTo('correction')" class="sidebar-icon active p-3 rounded-lg"
                title="Corrigir Redação"><i data-lucide="file-pen-line"></i></button>
            <button onclick="navigateTo('history')" class="sidebar-icon p-3 rounded-lg" title="Histórico"><i
                    data-lucide="history"></i></button>
            <button onclick="navigateTo('stats')" class="sidebar-icon p-3 rounded-lg" title="Estatísticas"><i
                    data-lucide="bar-chart-3"></i></button>
            <button onclick="navigateTo('progress')" class="sidebar-icon p-3 rounded-lg" title="Progresso & Metas"><i
                    data-lucide="trending-up"></i></button>
            <button onclick="navigateTo('plans')" class="sidebar-icon p-3 rounded-lg" title="Planos e Preços"><i
                    data-lucide="gem"></i></button>
        </nav>
        <div class="mt-auto flex flex-col items-center space-y-4">
            <div class="text-center">
                <p id="credits-display" class="text-sm font-semibold"></p>
                <p class="text-xs opacity-75">créditos</p>
            </div>
            <button class="p-3 rounded-lg hover:bg-indigo-800 transition-colors" title="Sair"><i
                    data-lucide="log-out"></i></button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 md:p-10 bg-gray-50 overflow-y-auto">
        <div id="page-correction" class="page">
            <header class="mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Corretor de Redação</h1>
                <p class="text-gray-600 mt-1">Selecione a modalidade, cole sua redação ou envie um arquivo para uma
                    análise instantânea.</p>
            </header>
            <div class="mb-6"><label for="correction-mode"
                    class="block text-sm font-medium text-gray-700 mb-2">Modalidade de Correção:</label><select
                    id="correction-mode"
                    class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                    <option value="ENEM" selected>ENEM (Nota 0-1000)</option>
                    <option value="SSA">SSA - UPE (Nota 0-10)</option>
                </select></div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex border-b border-gray-200"><button id="tab-text"
                            class="tab-button px-4 py-2 font-semibold text-indigo-600 border-b-2 border-indigo-600">Digitar
                            Texto</button><button id="tab-file"
                            class="tab-button px-4 py-2 font-semibold text-gray-500">Enviar Arquivo</button></div>
                    <div id="content-text" class="mt-4">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">Sua Redação</h2><textarea id="essay-input"
                            class="w-full h-72 p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow duration-200"
                            placeholder="Insira o TEMA da redação na primeira linha..."></textarea><span id="word-count"
                            class="text-sm text-gray-500 mt-2 block">0 palavras</span>
                    </div>
                    <div id="content-file" class="hidden mt-4">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">Upload da Redação</h2>
                        <div id="dropzone"
                            class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 bg-gray-50 transition-colors">
                            <input type="file" id="file-input" class="hidden"
                                accept="image/png, image/jpeg, application/pdf"><i data-lucide="upload-cloud"
                                class="w-12 h-12 mx-auto text-gray-400"></i>
                            <p class="mt-2 text-gray-600">Arraste e solte ou clique para selecionar.</p>
                            <p class="text-xs text-gray-500 mt-1">PNG, JPG ou PDF</p>
                            <p id="file-name" class="mt-2 font-semibold text-indigo-700"></p>
                        </div>
                        <div id="file-preview-container" class="hidden mt-4 text-center"><img id="file-preview-image"
                                class="max-w-full max-h-40 inline-block rounded-lg shadow-md" /></div>
                        <div class="mt-4 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-r-lg">
                            <p class="font-bold">Atenção!</p>
                            <p class="text-sm">Para uma análise precisa, a caligrafia deve estar legível.</p>
                        </div>
                    </div>
                    <div class="flex justify-end items-center mt-4"><button id="submit-btn" onclick="handleCorrection()"
                            class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition-all duration-200 shadow hover:shadow-lg transform hover:-translate-y-0.5 disabled:bg-gray-400 disabled:cursor-not-allowed">Corrigir
                            Redação</button></div>
                </div>
                <div id="result-container" class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-700">Análise da Correção</h2>
                        <button id="download-pdf-btn" onclick="downloadCorrectionAsPDF()"
                            class="hidden bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors text-sm">
                            <i data-lucide="download" class="inline-block mr-2 w-4 h-4"></i>Baixar PDF
                        </button>
                    </div>
                    <div id="result-content" class="mt-4 text-gray-600 h-full">
                        <div id="placeholder" class="flex flex-col items-center justify-center h-full text-center"><i
                                data-lucide="clipboard-check" class="w-16 h-16 text-gray-300 mb-4"></i>
                            <h3 class="font-semibold text-gray-500">Aguardando sua redação</h3>
                            <p class="text-sm text-gray-400">O resultado detalhado aparecerá aqui.</p>
                        </div>
                        <div id="loader" class="hidden flex-col items-center justify-center h-full">
                            <div class="loader"></div>
                            <p class="mt-4 text-indigo-600 font-medium">Analisando... Isso pode levar um minuto.</p>
                        </div>
                        <div id="correction-output"
                            class="prose-custom max-w-none hidden h-[450px] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-history" class="page hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Histórico de Correções</h1>
            <div id="history-content" class="bg-white p-6 rounded-lg shadow-md"></div>
        </div>

        <div id="page-stats" class="page hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Estatísticas e Diagnóstico</h1>
            <div class="mb-6 bg-gray-200 p-1 rounded-lg flex space-x-1"><button onclick="renderStats('ENEM')"
                    id="stats-mode-ENEM"
                    class="mode-button w-full py-2 px-4 rounded-md font-semibold bg-white text-indigo-600 shadow">ENEM</button><button
                    onclick="renderStats('SSA')" id="stats-mode-SSA"
                    class="mode-button w-full py-2 px-4 rounded-md font-semibold text-gray-600">SSA</button></div>
            <div id="stats-content-wrapper">
                <div id="stats-content" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                <div id="error-map-container" class="mt-8"></div>
            </div>
        </div>

        <div id="page-progress" class="page hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Meu Progresso e Metas</h1>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Conquistas Desbloqueadas</h2>
                    <div id="achievements-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Sua Evolução</h2>
                    <div id="evolution-stats" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <div id="page-plans" class="page hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Nossos Planos</h1>
            <p class="text-gray-600 mb-8 text-center max-w-2xl mx-auto">Escolha o plano ideal para a sua preparação e
                garanta sua vaga na universidade!</p>
            <div class="flex flex-wrap justify-center gap-8">
                <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm border-2 border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800">Plano Gratuito</h2>
                    <p class="text-gray-500 mt-2">Para você começar.</p>
                    <div class="text-4xl font-bold text-gray-900 my-6">R$ 0<span
                            class="text-lg font-medium text-gray-500">/mês</span></div>
                    <ul class="space-y-3 text-gray-600">
                        <li class="flex items-center"><i data-lucide="check"
                                class="w-5 h-5 text-green-500 mr-2"></i>Créditos de teste</li>
                        <li class="flex items-center"><i data-lucide="x" class="w-5 h-5 text-red-500 mr-2"></i>Histórico
                            e estatísticas</li>
                    </ul><button
                        class="w-full mt-8 bg-gray-200 text-gray-700 font-semibold py-3 rounded-lg cursor-not-allowed">Seu
                        plano atual</button>
                </div>

                <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm border-2 border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800">Plano Avulso</h2>
                    <p class="text-gray-500 mt-2">Pague apenas quando usar.</p>
                    <div class="text-4xl font-bold text-gray-900 my-6">R$ 1<span
                            class="text-lg font-medium text-gray-500">/correção</span></div>
                    <ul class="space-y-3 text-gray-600">
                        <li class="flex items-center"><i data-lucide="check"
                                class="w-5 h-5 text-green-500 mr-2"></i>Correção sob demanda</li>
                        <li class="flex items-center"><i data-lucide="check"
                                class="w-5 h-5 text-green-500 mr-2"></i>Análise por IA completa</li>
                        <li class="flex items-center"><i data-lucide="check"
                                class="w-5 h-5 text-green-500 mr-2"></i>Ideal para usos esporádicos</li>
                    </ul>
                    <button
                        class="w-full mt-8 bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition-colors">Comprar
                        Créditos</button>
                </div>

                <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm border-2 border-indigo-600 relative">
                    <div
                        class="absolute top-0 -translate-y-1/2 bg-indigo-600 text-white px-4 py-1 rounded-full text-sm font-semibold">
                        MAIS POPULAR</div>
                    <h2 class="text-2xl font-bold text-gray-800">Pro Mensal</h2>
                    <p class="text-gray-500 mt-2">Correções ilimitadas e mais.</p>
                    <div class="text-4xl font-bold text-gray-900 my-6">R$ 29<span
                            class="text-lg font-medium text-gray-500">/mês</span></div>
                    <ul class="space-y-3 text-gray-600">
                        <li class="flex items-center"><i data-lucide="check"
                                class="w-5 h-5 text-green-500 mr-2"></i>Correções ilimitadas</li>
                        <li class="flex items-center"><i data-lucide="check"
                                class="w-5 h-5 text-green-500 mr-2"></i>Histórico e estatísticas</li>
                    </ul><button
                        class="w-full mt-8 bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition-colors">Assinar
                        Agora</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="achievement-modal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 transition-opacity duration-300">
        <div
            class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-sm transform scale-95 transition-transform duration-300">
            <i id="achievement-modal-icon" class="w-20 h-20 text-yellow-500 mx-auto mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Conquista Desbloqueada!</h2>
            <p id="achievement-modal-name" class="text-xl font-semibold text-indigo-600"></p>
            <p id="achievement-modal-description" class="text-gray-600 mb-6"></p><button
                onclick="closeAchievementModal()"
                class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700">Continuar</button>
        </div>
    </div>
    <div id="no-credits-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-sm"><i data-lucide="gem"
                class="w-16 h-16 text-indigo-500 mx-auto mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Seus créditos acabaram!</h2>
            <p class="text-gray-600 mb-6">Para continuar, adquira um de nossos planos.</p>
            <div class="flex justify-center gap-4"><button onclick="closeModalAndGoToPlans()"
                    class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700">Ver
                    Planos</button><button onclick="document.getElementById('no-credits-modal').classList.add('hidden')"
                    class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Fechar</button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-sm"><i data-lucide="alert-triangle"
                class="w-16 h-16 text-yellow-500 mx-auto mb-4"></i>
            <h2 id="alert-modal-title" class="text-2xl font-bold text-gray-800 mb-2">Atenção</h2>
            <p id="alert-modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center"><button
                    onclick="document.getElementById('alert-modal').classList.add('hidden')"
                    class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700">OK</button>
            </div>
        </div>
    </div>
    <div id="study-plan-modal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center space-x-3">
                    <div class="bg-indigo-100 p-2 rounded-full">
                        <i data-lucide="lightbulb" class="w-6 h-6 text-indigo-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Seu Plano de Estudos Personalizado</h2>
                </div>
                <button onclick="document.getElementById('study-plan-modal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            <div id="study-plan-content" class="prose-custom max-w-none overflow-y-auto pr-2">
                <!-- AI-generated study plan will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // ######################################################################
        // ### ATENÇÃO: Insira sua chave de API da OpenAI aqui para funcionar ###
        // ######################################################################
        const OPENAI_API_KEY = "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";

        const API_URL = 'https://api.openai.com/v1/chat/completions';
        const markdownConverter = new showdown.Converter();
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        const achievementsList = { firstCorrection: { name: "Primeiros Passos", description: "Corrigiu sua primeira redação.", icon: "footprints" }, fiveCorrections: { name: "Rumo à Excelência", description: "Corrigiu 5 redações.", icon: "rocket" }, first900: { name: "Clube dos 900", description: "Alcançou 900+ no ENEM.", icon: "trophy" }, first10: { name: "Nota Máxima SSA", description: "Alcançou 9.5+ no SSA.", icon: "award" }, consistentWriter: { name: "Escrita Consistente", description: "Usou a plataforma em 3 semanas diferentes.", icon: "calendar-check" } };

        let state = { currentPage: 'correction', history: [], credits: 999, activeTab: 'text', uploadedFile: null, correctionMode: 'ENEM', achievements: { firstCorrection: false, fiveCorrections: false, first900: false, first10: false, consistentWriter: false }, loginHistory: [], };

        const ui = {
            pages: document.querySelectorAll('.page'), sidebarIcons: document.querySelectorAll('.sidebar-icon'),
            essayInput: document.getElementById('essay-input'), wordCountEl: document.getElementById('word-count'),
            submitBtn: document.getElementById('submit-btn'), correctionOutput: document.getElementById('correction-output'),
            placeholder: document.getElementById('placeholder'), loader: document.getElementById('loader'),
            historyContent: document.getElementById('history-content'), creditsDisplay: document.getElementById('credits-display'),
            tabText: document.getElementById('tab-text'), tabFile: document.getElementById('tab-file'),
            contentText: document.getElementById('content-text'), contentFile: document.getElementById('content-file'),
            dropzone: document.getElementById('dropzone'), fileInput: document.getElementById('file-input'),
            fileNameEl: document.getElementById('file-name'), filePreviewContainer: document.getElementById('file-preview-container'),
            filePreviewImage: document.getElementById('file-preview-image'), correctionModeSelect: document.getElementById('correction-mode'),
            statsContentWrapper: document.getElementById('stats-content-wrapper'), statsContent: document.getElementById('stats-content'),
            errorMapContainer: document.getElementById('error-map-container'), studyPlanModal: document.getElementById('study-plan-modal'),
            studyPlanContent: document.getElementById('study-plan-content'), achievementsGrid: document.getElementById('achievements-grid'),
            evolutionStats: document.getElementById('evolution-stats'), achievementModal: document.getElementById('achievement-modal'),
            downloadPdfBtn: document.getElementById('download-pdf-btn'),
        };

        function navigateTo(pageId) {
            state.currentPage = pageId;
            ui.pages.forEach(p => p.classList.add('hidden'));
            const page = document.getElementById(`page-${pageId}`);
            if (page) page.classList.remove('hidden');

            ui.sidebarIcons.forEach(icon => {
                icon.classList.remove('active');
                if (icon.getAttribute('onclick').includes(`'${pageId}'`)) icon.classList.add('active');
            });
            if (pageId === 'history') renderHistory();
            if (pageId === 'stats') renderStats('ENEM');
            if (pageId === 'progress') renderProgressPage();
        }

        function setupEventListeners() {
            ui.essayInput.addEventListener('input', () => { const words = ui.essayInput.value.trim().split(/\s+/).filter(Boolean); ui.wordCountEl.textContent = `${words.length} palavras`; });
            ui.tabText.addEventListener('click', () => switchTab('text'));
            ui.tabFile.addEventListener('click', () => switchTab('file'));
            ui.correctionModeSelect.addEventListener('change', (e) => state.correctionMode = e.target.value);
            ui.dropzone.addEventListener('click', () => ui.fileInput.click());
            ui.dropzone.addEventListener('dragover', e => { e.preventDefault(); ui.dropzone.classList.add('border-indigo-500'); });
            ui.dropzone.addEventListener('dragleave', () => ui.dropzone.classList.remove('border-indigo-500'));
            ui.dropzone.addEventListener('drop', e => { e.preventDefault(); ui.dropzone.classList.remove('border-indigo-500'); if (e.dataTransfer.files.length > 0) processFile(e.dataTransfer.files[0]); });
            ui.fileInput.addEventListener('change', e => { if (e.target.files.length > 0) processFile(e.target.files[0]); });
        }

        async function handleCorrection() {
            if (OPENAI_API_KEY === "COLE_SUA_CHAVE_DA_API_DA_OPENAI_AQUI" || !OPENAI_API_KEY) { return showAlert("Chave de API não configurada."); }

            let payload, essayDataForHistory, essayText;
            const mode = ui.correctionModeSelect.value;
            if (state.activeTab === 'text') { essayText = ui.essayInput.value.trim(); essayDataForHistory = essayText; }
            else { if (!state.uploadedFile) return showAlert("Por favor, selecione um arquivo."); essayDataForHistory = state.uploadedFile.base64; }
            if (state.activeTab === 'text' && essayText.split(/\s+/).filter(Boolean).length < 50) { return showAlert("Escreva uma redação com pelo menos 50 palavras."); }

            const systemPrompt = getSystemPrompt(mode);
            if (state.activeTab === 'file') { payload = { model: "gpt-4o-mini", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: [{ type: "text", text: `Transcreva e avalie esta redação para ${mode}.` }, { type: "image_url", image_url: { "url": essayDataForHistory } }] }] }; }
            else { payload = { model: "gpt-4o-mini", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: essayDataForHistory }] }; }

            setLoadingState(true);
            try {
                const resultText = await callApiWithExponentialBackoff(payload);
                const { visibleText, structuredData } = parseCorrectionResponse(resultText);

                displayCorrection(visibleText);
                let theme = (state.activeTab === 'file') ? `Redação de '${state.uploadedFile.name}'` : essayDataForHistory.split('\n')[0];
                const newCorrection = { id: Date.now(), theme, essay: essayDataForHistory, isImage: state.activeTab === 'file', result: visibleText, errors: structuredData, date: new Date().toLocaleDateString('pt-BR'), mode: mode };

                state.history.push(newCorrection);
                checkAchievements(newCorrection);
                saveState();
                updateCreditsDisplay();
            } catch (error) {
                console.error("API Call Error:", error);
                ui.correctionOutput.innerHTML = `<p class="text-red-500">Ocorreu um erro ao processar sua redação. Verifique se sua chave de API está correta e tente novamente.</p>`;
                ui.placeholder.classList.add('hidden');
                ui.correctionOutput.classList.remove('hidden');
            }
            finally { setLoadingState(false); }
        }

        function parseCorrectionResponse(fullResponse) {
            const separator = "---###---";
            const parts = fullResponse.split(separator);
            const visibleText = parts[0];
            let structuredData = {};
            if (parts.length > 1) { try { structuredData = JSON.parse(parts[1]); } catch (e) { console.error("Could not parse structured data:", e, "Data:", parts[1]); } }
            return { visibleText, structuredData };
        }

        function getSystemPrompt(mode) {
            const promptENEM = `Você é um corretor de redação de elite, especialista no ENEM. Seu tom deve ser encorajador e educativo, focando em como o aluno pode melhorar. Seja justo na nota, mas considere o estágio de aprendizado do aluno, evitando penalidades excessivamente severas por pequenos deslizes, especialmente se a argumentação geral for boa. Siga estritamente e sem exceções o seguinte formato de saída em Markdown:

### DIAGNÓSTICO GERAL DA SUA REDAÇÃO
[Escreva um parágrafo curto e encorajador, resumindo a performance geral do texto, destacando um ponto positivo principal e a principal área para melhoria.]

**NOTA FINAL: [coloque a nota total aqui, de 0 a 1000]**

---

### ANÁLISE DETALHADA POR COMPETÊNCIA
* **Competência 1 (Domínio da norma culta): [nota de 0 a 200]**
    * *Comentário:* [Análise breve e objetiva (1-2 linhas) sobre os acertos e desvios gramaticais.]
* **Competência 2 (Compreensão da proposta, repertório e tipo textual): [nota de 0 a 200]**
    * *Comentário:* [Análise breve sobre a abordagem do tema, uso de repertório e adequação ao texto dissertativo-argumentativo.]
* **Competência 3 (Organização das ideias e argumentos): [nota de 0 a 200]**
    * *Comentário:* [Análise breve sobre a seleção, relação e organização dos argumentos em defesa do ponto de vista.]
* **Competência 4 (Coesão e Coerência): [nota de 0 a 200]**
    * *Comentário:* [Análise breve sobre o uso de conectivos e a articulação entre parágrafos e frases.]
* **Competência 5 (Proposta de intervenção): [nota de 0 a 200]**
    * *Comentário:* [Análise breve sobre a presença e o detalhamento dos 5 elementos da proposta (Agente, Ação, Meio, Finalidade, Detalhamento).]

---

### ANÁLISE ESTRUTURAL (PARÁGRAFO POR PARÁGRAFO)
* **Introdução:** [Feedback objetivo sobre a contextualização do tema, a apresentação da tese e a organização do parágrafo.]
* **Desenvolvimento 1:** [Feedback sobre o tópico frasal, a argumentação, o uso de repertório e o fechamento da ideia.]
* **Desenvolvimento 2:** [Feedback sobre o tópico frasal, a argumentação, o uso de repertório e o fechamento da ideia.]
* **Conclusão:** [Feedback sobre a retomada da tese e a efetividade e detalhamento da proposta de intervenção.]

---

### ANÁLISE DE TRECHOS E REESCRITA
[Selecione 2 ou 3 trechos específicos da redação que contêm desvios importantes ou que poderiam ser mais claros e eficazes. Para cada um, siga o modelo abaixo.]

* **Trecho 1 (do parágrafo X):** "[Copie aqui a frase ou período original do aluno]"
    * **Diagnóstico:** [Explique o problema de forma clara (ex: "Uso inadequado de vírgula, prejudicando a clareza" ou "Argumento vago, sem aprofundamento").]
    * **Sugestão de Reescrittura:** "[Apresente uma versão reescrita e melhorada do trecho, explicando brevemente o porquê da mudança.]"

* **Trecho 2 (do parágrafo Y):** "[Copie aqui a frase ou período original do aluno]"
    * **Diagnóstico:** [Explique o problema.]
    * **Sugestão de Reescrittura:** "[Apresente a versão reescrita.]"

---

### PLANO DE AÇÃO PARA EVOLUIR
* **🎯 Foco Principal:** [Identifique a competência ou a parte da estrutura que mais precisa de atenção.]
* **✍️ Ação 1:** [Dê uma sugestão de ação prática e específica. Ex: "Revise o uso de conectivos interparagrafais..."]
* **📚 Ação 2:** [Dê outra sugestão prática. Ex: "Fortaleça sua proposta de intervenção detalhando o 'Meio/Modo'..."]

---###---
{
  "gramatica": "[Identifique o principal tipo de erro gramatical, ex: Crase, Virgulação, Concordância]",
  "estrutura": "[Identifique a parte da estrutura do texto mais fraca, ex: Introdução, Desenvolvimento 1, Conclusão, Proposta de Intervenção]",
  "argumentacao": "[Identifique o principal problema na argumentação, ex: Generalização, Repertório mal aplicado, Argumento circular]"
}`;

            const promptSSA = `Você é um corretor de redação de elite, especialista no vestibular SSA da UPE. Sua análise é detalhada, organizada e didática. Seja justo na nota, mas adote um tom encorajador e educativo. Siga estritamente e sem exceções o seguinte formato de saída em Markdown:

### DIAGNÓSTICO GERAL DA SUA REDAÇÃO (SSA)
[Escreva um parágrafo curto e encorajador, resumindo a performance geral do texto, destacando um ponto positivo principal e a principal área para melhoria.]

**NOTA FINAL: [coloque a nota total aqui, de 0 a 10, com uma casa decimal, ex: 8.5]**

---

### ANÁLISE DETALHADA POR CRITÉRIO
* **Tema e Tipo de Texto:** [Análise detalhada sobre a adequação ao tema e ao gênero textual proposto.]
* **Argumentação:** [Análise detalhada da qualidade, progressão e defesa dos argumentos.]
* **Coesão e Coerência:** [Análise detalhada dos conectivos, da estrutura dos parágrafos e da lógica textual.]
* **Modalidade Linguística:** [Análise detalhada do domínio da norma-padrão da língua portuguesa (gramática, ortografia, etc.).]

---

### ANÁLISE DE TRECHOS E REESCRITA
[Selecione 2 trechos específicos da redação que contêm desvios importantes ou que poderiam ser mais claros e eficazes. Para cada um, siga o modelo abaixo.]

* **Trecho 1 (do parágrafo X):** "[Copie aqui a frase ou período original do aluno]"
    * **Diagnóstico:** [Explique o problema de forma clara.]
    * **Sugestão de Reescrittura:** "[Apresente uma versão reescrita e melhorada do trecho.]"

---

### PLANO DE AÇÃO PARA EVOLUIR
* **🎯 Foco Principal:** [Identifique o critério que mais precisa de atenção.]
* **✍️ Ação 1:** [Dê uma sugestão de ação prática e específica para melhorar no critério mais fraco.]
* **📚 Ação 2:** [Dê outra sugestão prática e específica.]

---###---
{
  "gramatica": "[Identifique o principal erro gramatical]",
  "estrutura": "[Identifique a parte da estrutura mais fraca]",
  "argumentacao": "[Identifique o principal problema na argumentação]"
}`;

            return mode === 'SSA' ? promptSSA : promptENEM;
        }

        async function callApiWithExponentialBackoff(payload, retries = 3, delay = 1000) {
            try { const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_API_KEY}` }, body: JSON.stringify(payload) }); if (!response.ok) { const errorBody = await response.json(); console.error("OpenAI API Error:", errorBody); throw new Error(`HTTP error! status: ${response.status}`); } const data = await response.json(); return data.choices[0].message.content; }
            catch (error) { if (retries > 0) { await new Promise(res => setTimeout(res, delay)); return callApiWithExponentialBackoff(payload, retries - 1, delay * 2); } else { throw error; } }
        }

        function renderStats(mode) {
            document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('bg-white', 'text-indigo-600', 'shadow'));
            document.getElementById(`stats-mode-${mode}`).classList.add('bg-white', 'text-indigo-600', 'shadow');
            const filteredHistory = state.history.filter(item => item.mode === mode);

            if (filteredHistory.length < 2) {
                ui.statsContentWrapper.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md text-center text-gray-500">É preciso ter pelo menos 2 correções na modalidade ${mode} para gerar diagnósticos.</div>`;
                return;
            }
            ui.statsContentWrapper.innerHTML = `<div id="stats-content" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div><div id="error-map-container" class="mt-8"></div>`;
            const statsContent = document.getElementById('stats-content');
            const errorMapContainer = document.getElementById('error-map-container');

            const scores = filteredHistory.map(item => { const match = item.result.match(/\*\*NOTA FINAL: ([\d,.]+)\*\*/); return match ? parseFloat(match[1].replace(',', '.')) : 0; });
            const maxScore = mode === 'ENEM' ? 1000 : 10;
            const scoreChartHTML = createSvgLineChart(scores, maxScore);
            let criteriaHTML = '';
            if (mode === 'ENEM') {
                const competenceTotals = [0, 0, 0, 0, 0];
                filteredHistory.forEach(item => { const matches = item.result.matchAll(/\*\*Competência \d.*:\s*\[(\d+)\]/g); Array.from(matches, (match, i) => { if (i < 5 && match[1]) competenceTotals[i] += parseInt(match[1]); }); });
                criteriaHTML = competenceTotals.map((total, i) => { const avg = (total / filteredHistory.length).toFixed(0); return `<div><div class="flex justify-between mb-1"><span class="text-base font-medium text-gray-700">Competência ${i + 1}</span><span class="text-sm font-medium text-gray-700">${avg}/200</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${(avg / 200) * 100}%"></div></div></div>`; }).join('');
            } else { criteriaHTML = `<p class="text-center text-gray-500">Análise de critérios para SSA em breve.</p>`; }
            statsContent.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-semibold text-gray-700 mb-4">Evolução da Nota (${mode})</h2><div class="h-64">${scoreChartHTML}</div></div><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-semibold text-gray-700 mb-4">Média por Competência</h2><div class="space-y-4">${criteriaHTML}</div></div>`;

            const errorFrequencies = { gramatica: {}, estrutura: {}, argumentacao: {} };
            filteredHistory.forEach(item => { if (item.errors) { const { gramatica, estrutura, argumentacao } = item.errors; if (gramatica) errorFrequencies.gramatica[gramatica] = (errorFrequencies.gramatica[gramatica] || 0) + 1; if (estrutura) errorFrequencies.estrutura[estrutura] = (errorFrequencies.estrutura[estrutura] || 0) + 1; if (argumentacao) errorFrequencies.argumentacao[argumentacao] = (errorFrequencies.argumentacao[argumentacao] || 0) + 1; } });
            errorMapContainer.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-semibold text-gray-700 mb-4">Mapa de Erros Frequentes</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6">${createErrorBarChartHTML('Erros Gramaticais', errorFrequencies.gramatica)}${createErrorBarChartHTML('Pontos Estruturais', errorFrequencies.estrutura)}${createErrorBarChartHTML('Erros de Argumentação', errorFrequencies.argumentacao)}</div><div class="text-center mt-6"><button onclick="generateStudyPlan()" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700"><i data-lucide="lightbulb" class="inline-block mr-2"></i>Gerar Plano de Estudos</button></div></div>`;
            lucide.createIcons();
        }

        function createErrorBarChartHTML(title, data) {
            const sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]);
            if (sortedData.length === 0) return `<div><h3 class="font-semibold text-gray-600">${title}</h3><p class="text-sm text-gray-500">Nenhum dado.</p></div>`;
            const total = sortedData.reduce((sum, item) => sum + item[1], 0);
            const bars = sortedData.slice(0, 3).map(([label, count]) => { const percentage = ((count / total) * 100).toFixed(0); return `<div class="w-full"><div class="flex justify-between mb-1"><span class="text-sm font-medium text-gray-600">${label}</span><span class="text-sm font-medium text-gray-500">${percentage}%</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-amber-500 h-2 rounded-full" style="width: ${percentage}%"></div></div></div>`; }).join('');
            return `<div><h3 class="font-semibold text-gray-600 mb-3">${title}</h3><div class="space-y-3">${bars}</div></div>`;
        }

        async function generateStudyPlan() {
            const filteredHistory = state.history.filter(item => item.mode === 'ENEM');
            if (filteredHistory.length === 0) return showAlert("Você precisa de pelo menos uma correção para gerar um plano.");
            const errorFrequencies = { gramatica: {}, estrutura: {}, argumentacao: {} };
            filteredHistory.forEach(item => { if (item.errors) { const { gramatica, estrutura, argumentacao } = item.errors; if (gramatica) errorFrequencies.gramatica[gramatica] = (errorFrequencies.gramatica[gramatica] || 0) + 1; if (estrutura) errorFrequencies.estrutura[estrutura] = (errorFrequencies.estrutura[estrutura] || 0) + 1; if (argumentacao) errorFrequencies.argumentacao[argumentacao] = (errorFrequencies.argumentacao[argumentacao] || 0) + 1; } });
            const getMostFrequent = (data) => Object.entries(data).sort((a, b) => b[1] - a[1]).slice(0, 2).map(i => i[0]).join(', ');
            const summary = `Erros gramaticais: ${getMostFrequent(errorFrequencies.gramatica)}. Pontos estruturais: ${getMostFrequent(errorFrequencies.estrutura)}. Problemas de argumentação: ${getMostFrequent(errorFrequencies.argumentacao)}.`;
            const prompt = `Baseado nos seguintes erros frequentes de um aluno: "${summary}", crie um plano de estudos de uma semana, curto e objetivo, com 3 ações práticas para melhorar. Use um tom encorajador. Formate em Markdown.`;
            ui.studyPlanContent.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>';
            ui.studyPlanModal.classList.remove('hidden');
            try {
                const planText = await callApiWithExponentialBackoff({ model: "gpt-4o-mini", messages: [{ role: "system", content: "Você é um tutor de redação." }, { role: "user", content: prompt }] });
                ui.studyPlanContent.innerHTML = markdownConverter.makeHtml(planText);
                lucide.createIcons();
            } catch (error) { console.error("Study Plan Error:", error); ui.studyPlanContent.innerHTML = '<p class="text-red-500">Não foi possível gerar o plano. Tente novamente.</p>'; }
        }

        function checkAchievements(newCorrection) {
            if (!state.achievements.firstCorrection) unlockAchievement('firstCorrection');
            if (state.history.length >= 5 && !state.achievements.fiveCorrections) unlockAchievement('fiveCorrections');
            const noteMatch = newCorrection.result.match(/\*\*NOTA FINAL: ([\d,.]+)\*\*/);
            if (noteMatch) {
                const score = parseFloat(noteMatch[1].replace(',', '.'));
                if (newCorrection.mode === 'ENEM' && score >= 900 && !state.achievements.first900) unlockAchievement('first900');
                if (newCorrection.mode === 'SSA' && score >= 9.5 && !state.achievements.first10) unlockAchievement('first10');
            }
        }

        function updateLoginHistoryAndCheckConsistency() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime();
            if (!state.loginHistory.includes(todayTimestamp)) { state.loginHistory.push(todayTimestamp); }
            const uniqueWeeks = new Set(state.loginHistory.map(ts => getWeekNumber(new Date(ts))));
            if (uniqueWeeks.size >= 3 && !state.achievements.consistentWriter) { unlockAchievement('consistentWriter'); }
            saveState();
        }

        function unlockAchievement(id) { if (!state.achievements[id]) { state.achievements[id] = true; showAchievementModal(id); saveState(); } }

        function renderHistory() {
            if (state.history.length === 0) { ui.historyContent.innerHTML = `<p class="text-gray-500 text-center">Nenhuma redação foi corrigida ainda.</p>`; return; }
            let historyHTML = `<div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-4 font-semibold">Data</th><th class="p-4 font-semibold">Tema</th><th class="p-4 font-semibold">Modalidade</th><th class="p-4 font-semibold">Nota</th><th class="p-4 font-semibold">Ações</th></tr></thead><tbody>`;
            [...state.history].reverse().forEach(item => { const noteMatch = item.result.match(/\*\*NOTA FINAL: ([\d,.]+)\*\*/); const score = noteMatch ? noteMatch[1] : 'N/A'; historyHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-4">${item.date}</td><td class="p-4 truncate max-w-xs">${item.theme}</td><td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${item.mode === 'ENEM' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">${item.mode}</span></td><td class="p-4 font-bold ${getScoreColor(score, item.mode)}">${score}</td><td class="p-4"><button onclick="viewHistoryItem(${item.id})" class="text-indigo-600 hover:underline">Ver Análise</button></td></tr>`; });
            ui.historyContent.innerHTML = historyHTML + `</tbody></table></div>`;
        }

        function viewHistoryItem(id) {
            const item = state.history.find(h => h.id === id);
            if (item) {
                navigateTo('correction'); ui.correctionModeSelect.value = item.mode; state.correctionMode = item.mode;
                if (item.isImage) { switchTab('file'); updateFileStateAndPreview(item.theme, 'image/jpeg', item.essay); ui.essayInput.value = ''; }
                else { switchTab('text'); ui.essayInput.value = item.essay; resetFileInput(); }
                displayCorrection(item.result); ui.placeholder.classList.add('hidden'); ui.loader.classList.add('hidden');
            }
        }

        function renderProgressPage() {
            ui.achievementsGrid.innerHTML = Object.entries(achievementsList).map(([id, ach]) => { const unlocked = state.achievements[id]; return `<div class="achievement-card ${unlocked ? 'unlocked' : 'locked'} border-2 p-4 rounded-lg flex items-center space-x-4"><i data-lucide="${ach.icon}" class="w-10 h-10 ${unlocked ? 'text-yellow-500' : 'text-gray-400'}"></i><div><h3 class="font-bold text-gray-800">${ach.name}</h3><p class="text-sm text-gray-600">${ach.description}</p></div></div>`; }).join('');
            let evolutionHTML = '<p class="text-gray-500">Corrija mais redações para ver sua evolução.</p>';
            const enemHistory = state.history.filter(h => h.mode === 'ENEM' && h.result.match(/\*\*NOTA FINAL: ([\d,.]+)\*\*/));
            if (enemHistory.length >= 2) { const scores = enemHistory.map(h => parseFloat(h.result.match(/\*\*NOTA FINAL: ([\d,.]+)\*\*/)[1].replace(',', '.'))); const maxJump = scores.slice(1).reduce((max, score, i) => Math.max(max, score - scores[i]), 0); const overallGrowth = scores[scores.length - 1] - scores[0]; evolutionHTML = `<div class="p-4 bg-green-50 rounded-lg"><h4 class="font-semibold">Maior Salto de Nota (ENEM)</h4><p class="text-2xl font-bold text-green-600">+${maxJump.toFixed(0)} pontos</p><p class="text-sm text-gray-500">Entre duas correções consecutivas.</p></div><div class="p-4 bg-blue-50 rounded-lg"><h4 class="font-semibold">Crescimento Total (ENEM)</h4><p class="text-2xl font-bold text-blue-600">${overallGrowth >= 0 ? '+' : ''}${overallGrowth.toFixed(0)} pontos</p><p class="text-sm text-gray-500">Da sua primeira à última redação.</p></div>`; }
            ui.evolutionStats.innerHTML = evolutionHTML;
            lucide.createIcons();
        }

        function switchTab(targetTab) { state.activeTab = targetTab; if (targetTab === 'file') { ui.contentFile.classList.remove('hidden'); ui.contentText.classList.add('hidden'); ui.tabFile.classList.add('text-indigo-600', 'border-indigo-600'); ui.tabFile.classList.remove('text-gray-500'); ui.tabText.classList.add('text-gray-500'); ui.tabText.classList.remove('text-indigo-600', 'border-indigo-600'); } else { ui.contentText.classList.remove('hidden'); ui.contentFile.classList.add('hidden'); ui.tabText.classList.add('text-indigo-600', 'border-indigo-600'); ui.tabText.classList.remove('text-gray-500'); ui.tabFile.classList.add('text-gray-500'); ui.tabFile.classList.remove('text-indigo-600', 'border-indigo-600'); } }
        function setLoadingState(isLoading) {
            ui.downloadPdfBtn.classList.add('hidden');
            if (isLoading) { ui.placeholder.classList.add('hidden'); ui.correctionOutput.classList.add('hidden'); ui.loader.classList.remove('hidden'); ui.submitBtn.disabled = true; ui.submitBtn.textContent = 'Analisando...'; }
            else { ui.loader.classList.add('hidden'); ui.submitBtn.disabled = false; ui.submitBtn.textContent = 'Corrigir Redação'; }
        }
        function displayCorrection(markdownText) { const htmlContent = markdownConverter.makeHtml(markdownText); ui.correctionOutput.innerHTML = htmlContent; ui.correctionOutput.classList.remove('hidden'); ui.downloadPdfBtn.classList.remove('hidden'); lucide.createIcons(); }
        async function downloadCorrectionAsPDF() {
            const { jsPDF } = window.jspdf;
            const correctionElement = document.getElementById('correction-output');
            ui.downloadPdfBtn.disabled = true;
            try {
                const canvas = await html2canvas(correctionElement, { scale: 2, useCORS: true, scrollY: 0 });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = imgWidth / pdfWidth;
                const scaledHeight = imgHeight / ratio;

                let position = 0;
                let heightLeft = scaledHeight;

                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, scaledHeight);
                heightLeft -= pdfHeight;

                while (heightLeft > 0) {
                    position = -heightLeft;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, scaledHeight);
                    heightLeft -= pdfHeight;
                }
                pdf.save('analise-redacao.pdf');
            } catch (error) { console.error("Error generating PDF:", error); showAlert("Erro ao gerar o PDF."); }
            finally { ui.downloadPdfBtn.disabled = false; }
        }
        function processFile(file) { if (file.type === 'application/pdf') { handlePdf(file); } else if (file.type.startsWith('image/')) { handleImage(file); } else { showAlert('Formato de arquivo inválido.'); resetFileInput(); } }
        async function handlePdf(file) { const reader = new FileReader(); reader.onload = async (e) => { try { setLoadingState(true); const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise; const page = await pdf.getPage(1); const viewport = page.getViewport({ scale: 2.0 }); const canvas = document.createElement('canvas'); const context = canvas.getContext('2d'); canvas.height = viewport.height; canvas.width = viewport.width; await page.render({ canvasContext: context, viewport: viewport }).promise; const base64 = canvas.toDataURL('image/jpeg'); updateFileStateAndPreview(file.name, 'image/jpeg', base64); } catch (error) { console.error('Error processing PDF:', error); showAlert('Não foi possível processar o PDF.'); resetFileInput(); } finally { setLoadingState(false); } }; reader.readAsArrayBuffer(file); }
        function handleImage(file) { const reader = new FileReader(); reader.onload = (e) => updateFileStateAndPreview(file.name, file.type, e.target.result); reader.readAsDataURL(file); }
        function updateFileStateAndPreview(name, type, base64) { state.uploadedFile = { name, type, base64 }; ui.fileNameEl.textContent = name; ui.filePreviewImage.src = base64; ui.filePreviewContainer.classList.remove('hidden'); }
        function resetFileInput() { ui.fileInput.value = ''; state.uploadedFile = null; ui.fileNameEl.textContent = ''; ui.filePreviewContainer.classList.add('hidden'); }
        function createSvgLineChart(data, maxVal) { const width = 350, height = 250, padding = 40; const maxX = data.length - 1; if (maxX < 1) return '<p>Dados insuficientes.</p>'; const points = data.map((d, i) => `${padding + (i / maxX) * (width - 2 * padding)},${height - padding - (d / maxVal) * (height - 2 * padding)}`).join(' '); let yAxisLabels = ''; for (let i = 0; i <= 10; i++) { const val = (i / 10) * maxVal; yAxisLabels += `<text x="${padding - 10}" y="${height - padding - (i / 10) * (height - 2 * padding) + 5}" text-anchor="end" font-size="12" fill="#6b7280">${val.toFixed(0)}</text>`; } return `<svg viewBox="0 0 ${width} ${height}" class="w-full h-full"><line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding}" stroke="#d1d5db" />${yAxisLabels}<line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="#d1d5db" /><polyline fill="none" stroke="#4f46e5" stroke-width="2" points="${points}" />${data.map((d, i) => `<circle cx="${padding + (i / maxX) * (width - 2 * padding)}" cy="${height - padding - (d / maxVal) * (height - 2 * padding)}" r="4" fill="#4f46e5"><title>Correção ${i + 1}: ${d.toFixed(2)}</title></circle>`).join('')}</svg>`; }
        function getScoreColor(score, mode) { const numericScore = parseFloat(String(score).replace(',', '.')); if (isNaN(numericScore)) return 'text-gray-700'; const maxScore = mode === 'ENEM' ? 1000 : 10; const percentage = (numericScore / maxScore) * 100; if (percentage >= 90) return 'text-green-600'; if (percentage >= 70) return 'text-blue-600'; if (percentage >= 50) return 'text-yellow-600'; return 'text-red-600'; }
        function showAlert(message, title = 'Atenção') { document.getElementById('alert-modal-title').textContent = title; document.getElementById('alert-modal-message').textContent = message; document.getElementById('alert-modal').classList.remove('hidden'); }
        function closeModalAndGoToPlans() { document.getElementById('no-credits-modal').classList.add('hidden'); navigateTo('plans'); }
        function showAchievementModal(id) { const ach = achievementsList[id]; document.getElementById('achievement-modal-icon').innerHTML = `<i data-lucide="${ach.icon}"></i>`; document.getElementById('achievement-modal-name').textContent = ach.name; document.getElementById('achievement-modal-description').textContent = ach.description; ui.achievementModal.classList.remove('hidden'); setTimeout(() => { ui.achievementModal.classList.add('opacity-100'); ui.achievementModal.querySelector('div').classList.add('scale-100'); }, 10); lucide.createIcons(); }
        function closeAchievementModal() { ui.achievementModal.classList.remove('opacity-100'); ui.achievementModal.querySelector('div').classList.remove('scale-100'); setTimeout(() => ui.achievementModal.classList.add('hidden'), 300); }
        function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - yearStart) / 86400000) + 1) / 7); }

        function updateCreditsDisplay() { ui.creditsDisplay.textContent = state.credits; }
        function saveState() { localStorage.setItem('redator1000_state', JSON.stringify(state)); }
        function loadState() { const savedState = localStorage.getItem('redator1000_state'); if (savedState) { const loaded = JSON.parse(savedState); state = { ...state, ...loaded }; if (loaded.achievements) state.achievements = { ...state.achievements, ...loaded.achievements }; } }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadState();
            updateLoginHistoryAndCheckConsistency();
            updateCreditsDisplay();
            setupEventListeners();
            navigateTo('correction');
        });
    </script>
</body>

</html>
